<!DOCTYPE html>
<html>
<head>
  <title>¡Compra exitosa!</title>
</head>
<body>
  <h1>¡Gracias por tu compra!</h1>
  <script>
    const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
    async function descontarStock() {
      for (const item of carrito) {
        await fetch('/api/descontar-stock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: item.id,
            talla: item.talla,
            cantidad: item.cantidad
          })
        });
      }
      localStorage.removeItem("carrito");

      // Ahora pide los productos actualizados y guárdalos en localStorage
      const res = await fetch('/api/productos');
      const productosActualizados = await res.json();
      localStorage.setItem("productos", JSON.stringify(productosActualizados));
    }
    descontarStock();
  </script>
</body>
</html>